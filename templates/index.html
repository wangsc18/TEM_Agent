<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>C172 TEM è®­ç»ƒå™¨ V2 - è§’è‰²åˆ†å·¥ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* å…¨å±€æ·±è‰²é£æ ¼ */
        body { background-color: #1e1e2f; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .panel { background: #2a2a40; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #444; }

        /* === Phase 1: æ–‡å­—äº¤äº’ === */
        .tem-label { color: #0dcaf0; font-weight: bold; display: block; margin-top: 10px; }
        .tem-word {
            cursor: pointer; padding: 2px 5px; margin: 0 2px; border-radius: 4px;
            border: 1px solid transparent; display: inline-block; transition: 0.2s;
        }
        /* ç§»é™¤å¨èƒè¯çš„é»„è‰²é«˜äº®ï¼Œè®©å­¦å‘˜è‡ªå·±è¯†åˆ« */
        .tem-word:hover { background-color: #3e3e5e; border-color: #666; }
        .tem-word.threat-processed { background-color: #28a745; color: white; font-weight: bold; }

        /* === Phase 2: ä»ªè¡¨ä¸èˆªè·¯ === */
        .gauge-row { display: flex; justify-content: space-around; flex-wrap: wrap; padding: 15px 0; background: #222; border-radius: 8px; margin-bottom: 15px; }
        .gauge {
            width: 100px; height: 100px; background: #fff; border-radius: 50%;
            position: relative; border: 4px solid #555; margin: 5px;
            cursor: pointer; transition: border-color 0.3s, transform 0.2s;
        }
        .gauge:hover { transform: scale(1.05); }
        .gauge.monitored { border-color: #0dcaf0; box-shadow: 0 0 15px #0dcaf0; }
        .gauge-label { position: absolute; top: 65%; width: 100%; text-align: center; font-size: 12px; color: #000; font-weight: bold; }
        .gauge-needle {
            width: 3px; height: 45px; background: #d63384; position: absolute;
            left: 48%; top: 5%; transform-origin: bottom center;
            transition: transform 0.15s linear; z-index: 10;
        }
        .gauge-center { width: 12px; height: 12px; background: #333; border-radius: 50%; position: absolute; top: 44%; left: 44%; z-index: 11;}
        .oil-green { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 6px solid transparent; border-top-color: #28a745; border-right-color: #28a745; transform: rotate(-45deg); opacity: 0.5; }

        /* è™šæ‹Ÿèˆªè·¯ */
        .route-box { position: relative; height: 100px; background: #181824; border: 1px solid #444; border-radius: 8px; overflow: hidden; }
        .route-line { position: absolute; top: 50%; left: 20px; right: 20px; height: 2px; background: #555; }
        .route-text { position: absolute; top: 60%; color: #888; font-size: 12px; }

        #plane-icon {
            position: absolute; top: 30%; left: 20px; font-size: 24px;
            transform: translateX(-50%); transition: left 0.15s linear;
        }

        .event-dot {
            position: absolute; top: 45%; width: 12px; height: 12px; border-radius: 50%;
            transform: translateX(-50%); z-index: 5; border: 2px solid #fff;
        }
        .dot-warning { background-color: #ffc107; }
        .dot-failure { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; }

        /* === Phase 3: æ£€æŸ¥å• === */
        .checklist-item { padding: 10px; border-bottom: 1px solid #555; cursor: pointer; background: #333; }
        .checklist-item:hover { background: #444; }
        .checklist-item.done { background-color: #198754; text-decoration: line-through; }

        /* === æ–°å¢ï¼šå¨èƒç®¡ç†é¢æ¿ === */
        .threat-status-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #666;
            background: #333;
            font-size: 0.85em;
        }
        .threat-status-item.success { border-left-color: #28a745; background-color: #1a3d2a; }
        .threat-status-item.pm_error { border-left-color: #ffc107; background-color: #3d3020; }
        .threat-status-item.critical_error { border-left-color: #dc3545; background-color: #3d1f1f; }
        .threat-status-item.pm_catch { border-left-color: #17a2b8; background-color: #1f2f3d; }

        /* SOP æ˜¾ç¤ºé¢æ¿ */
        .sop-panel {
            background: #1a1a2e;
            border: 2px solid #0dcaf0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .sop-panel h6 { color: #0dcaf0; margin-bottom: 10px; }
        .sop-panel ul { margin: 0; padding-left: 20px; }
        .sop-panel li { margin: 5px 0; font-size: 0.9em; }

        /* æµ‹è¯•é¢˜æ ·å¼ */
        .quiz-container { display: none; }
        .quiz-question {
            background: #2a2a40;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #0dcaf0;
        }
        .quiz-option {
            padding: 10px 15px;
            margin: 8px 0;
            background: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .quiz-option:hover { background: #444; }
        .quiz-option.selected { background: #0dcaf0; color: #000; font-weight: bold; }
        .quiz-option.correct { background: #28a745; color: white; }
        .quiz-option.wrong { background: #dc3545; color: white; }

        /* åŠ¨ç”» */
        .blink { animation: blink-anim 1s infinite; }
        @keyframes blink-anim { 50% { opacity: 0.5; } }
        .modal-dark { background-color: #2a2a40; color: white; border: 1px solid #555; }

        /* è§’è‰²æ ‡è¯† */
        .role-badge-pf { background-color: #d63384; }
        .role-badge-pm { background-color: #0dcaf0; color: #000; }

        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9em;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç³»ç»Ÿæ¶ˆæ¯ - å±…ä¸­ç°è‰² */
        .msg-system {
            background: #2a2a40;
            color: #888;
            text-align: center;
            margin: 6px auto;
            font-size: 0.85em;
            max-width: 90%;
            border-left: 3px solid #555;
        }

        /* PFæ¶ˆæ¯ - å³ä¾§ç²‰çº¢è‰² */
        .msg-pf {
            background: linear-gradient(135deg, #d63384, #c02570);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        /* PMæ¶ˆæ¯ - å·¦ä¾§è“è‰² */
        .msg-pm {
            background: linear-gradient(135deg, #0dcaf0, #0aa3c7);
            color: #000;
            margin-right: auto;
            text-align: left;
        }

        .msg-sender {
            font-weight: bold;
            font-size: 0.75em;
            opacity: 0.9;
            display: block;
            margin-bottom: 3px;
        }

        .msg-timestamp {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 3px;
        }

        /* å¯æŠ˜å QRHåº“æ ·å¼ */
        .collapsible-panel {
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .collapsible-header {
            background: linear-gradient(135deg, #3e3e5e, #2a2a40);
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, #4e4e6e, #3a3a50);
        }

        .collapsible-header h6 {
            margin: 0;
            color: #0dcaf0;
            font-size: 0.95em;
        }

        .collapsible-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #0dcaf0;
        }

        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 15px;
        }

        .collapsible-content.expanded {
            max-height: 500px;
            padding: 15px;
        }

        .qrh-button {
            margin-bottom: 8px;
        }

        .language-toggle {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: #2a2a40;
            border: 1px solid #444;
            border-radius: 999px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1200;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }

        .language-toggle label {
            margin: 0;
            font-size: 0.85em;
        }

        .language-toggle select {
            background: #1e1e2f;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 999px;
            padding: 2px 10px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
<div class="language-toggle">
    <label for="language-select" class="text-white small" data-i18n="language.toggle">Language</label>
    <select id="language-select" onchange="handleLanguageChange(this.value)">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
    </select>
</div>

<div class="container py-3">
    <!-- é¡¶éƒ¨æ  -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <h4 class="m-0" id="app-title" data-i18n="header.title">âœˆï¸ C172 TEM è®­ç»ƒå™¨ V2</h4>
            <span class="badge bg-secondary" id="phase-badge" data-i18n="phase.badge.wait">Wait</span>
            <span class="badge bg-dark border border-secondary" id="room-badge" style="display:none;"></span>
        </div>
        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end">
            <!-- è¯­éŸ³å¼€å…³ -->
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="voice-toggle" onchange="toggleVoice()">
                <label class="form-check-label text-white" for="voice-toggle" id="voice-toggle-label" data-i18n="voice.toggle">
                    ğŸ”Š è¯­éŸ³æ’­æŠ¥
                </label>
            </div>
            <!-- åˆ†æ•°æ˜¾ç¤º -->
            <span class="badge bg-warning text-dark" id="score-badge">
                <span id="score-label" data-i18n="score.label">Score</span>: <span id="score">0</span>
            </span>
        </div>
    </div>

    <!-- ç™»å½• -->
    <div id="login-panel" class="row justify-content-center mt-5">
        <div class="col-md-4">
            <div class="panel p-4 text-center">
                <h3 class="mb-3" data-i18n="login.title">é£è¡Œå‡†å¤‡</h3>

                <!-- æ–°å¢ï¼šè®­ç»ƒæ¨¡å¼é€‰æ‹© -->
                <div class="mb-3 text-start">
                    <label class="form-label text-muted small" data-i18n="login.mode.label">è®­ç»ƒæ¨¡å¼ (Training Mode)</label>
                    <select id="mode" class="form-select bg-dark text-white border-secondary">
                        <option value="dual_player" data-i18n="login.mode.dual">ğŸ§‘â€âœˆï¸ğŸ§‘â€âœˆï¸ åŒäººåä½œæ¨¡å¼ (2 Players)</option>
                        <option value="single_player" data-i18n="login.mode.single">ğŸ§‘â€âœˆï¸ğŸ¤– å•äºº+AIæ¨¡å¼ (1 Player + AI Partner)</option>
                    </select>
                    <small class="text-muted" style="font-size: 0.7em" data-i18n="login.mode.note">
                        å•äººæ¨¡å¼ï¼šAIå°†æ‰®æ¼”å¦ä¸€ä¸ªè§’è‰²ä¸ä½ åä½œè®­ç»ƒ
                    </small>
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label text-muted small" data-i18n="login.room.label">è®­ç»ƒæˆ¿é—´å· (Room ID)</label>
                    <input id="room-id" class="form-control bg-dark text-white border-secondary" placeholder="ä¾‹å¦‚: 8888" data-i18n-placeholder="login.room.placeholder">
                    <small class="text-muted" style="font-size: 0.7em" data-i18n="login.room.note">å’Œä½ çš„æ­æ¡£è¾“å…¥ç›¸åŒçš„æˆ¿é—´å·</small>
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label text-muted small" data-i18n="login.username.label">å‘¼å· (Callsign)</label>
                    <input id="username" class="form-control bg-dark text-white border-secondary" placeholder="ä¾‹å¦‚: Pilot A" data-i18n-placeholder="login.username.placeholder">
                </div>

                <div class="mb-3 text-start">
                    <label class="form-label text-muted small" data-i18n="login.role.label">èŒè´£ (Role)</label>
                    <select id="role" class="form-select bg-dark text-white border-secondary">
                        <option value="PF" data-i18n="login.role.pf">PF (æ“çºµé£è¡Œå‘˜)</option>
                        <option value="PM" data-i18n="login.role.pm">PM (ç›‘æ§é£è¡Œå‘˜)</option>
                    </select>
                </div>

                <button onclick="join()" class="btn btn-primary w-100" data-i18n="login.button">åŠ å…¥è®­ç»ƒ</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="sim-area" style="display:none;">
        <div class="row">

            <!-- å·¦ä¾§ï¼šä¸»æ˜¾ç¤ºåŒº -->
            <div class="col-md-8">

                <!-- Phase 1: èµ·é£å‰æ£€æŸ¥ -->
                <div id="phase1-panel" class="panel">
                    <h5 class="text-info border-bottom pb-2">
                        <span id="phase1-title" data-i18n="phase1.title">Phase 1: Pre-flight TEM (èµ·é£å‰å¨èƒç®¡ç†)</span>
                        <span id="my-role-badge" class="badge float-end"></span>
                    </h5>
                    <p class="small text-muted" data-i18n="phase1.instructions" data-i18n-mode="html">
                        <strong>PF</strong>: ç‚¹å‡»æ–‡æœ¬ä¸­çš„å¨èƒå…³é”®è¯ï¼ˆé»„è‰²é«˜äº®ï¼‰ï¼Œé€‰æ‹©åº”å¯¹æ–¹æ¡ˆ<br>
                        <strong>PM</strong>: æŸ¥çœ‹ PF æ–¹æ¡ˆï¼ŒéªŒè¯ SOP é™åˆ¶ï¼ŒåŒæ„/é©³å›å†³ç­–
                    </p>
                    <div id="preflight-content"></div>

                    <!-- å¨èƒå¤„ç†çŠ¶æ€ -->
                    <div id="threat-status-panel" class="mt-3" style="display:none;">
                        <h6 class="text-success" data-i18n="phase1.threatStatus.title">âœ… å·²å¤„ç†å¨èƒ</h6>
                        <div id="threat-status-list"></div>
                    </div>

                    <!-- ç´§æ€¥é¢„æ¡ˆæµ‹è¯• -->
                    <div id="quiz-container" class="quiz-container mt-4">
                        <h5 class="text-warning border-bottom pb-2" data-i18n="phase1.quiz.title">ğŸ“š ç´§æ€¥é¢„æ¡ˆçŸ¥è¯†æµ‹è¯• (PM æ“ä½œ)</h5>
                        <div id="quiz-questions"></div>
                    </div>

                    <button id="btn-start-quiz" onclick="startQuiz()" class="btn btn-warning w-100 mt-3" style="display:none;" data-i18n="phase1.quiz.button">
                        å¼€å§‹ç´§æ€¥é¢„æ¡ˆæµ‹è¯•
                    </button>
                    <button id="btn-next-phase" onclick="reqNext()" class="btn btn-success w-100 mt-3" style="display:none;" data-i18n="phase1.next.button">
                        æ£€æŸ¥å®Œæ¯•ï¼Œå‡†å¤‡èµ·é£ (Cross-check)
                    </button>
                </div>

                <!-- Phase 2: é£è¡Œç›‘æ§ -->
                <div id="phase2-panel" class="panel" style="display:none;">
                    <h5 class="text-warning border-bottom pb-2" id="phase2-title" data-i18n="phase2.title">Phase 2: In-flight (ç©ºä¸­å·¡èˆª)</h5>
                    <p class="small text-info" id="phase2-tip" data-i18n="phase2.tip">ğŸ’¡ ç‚¹å‡»ä»ªè¡¨æ ‡è®°ç›‘æ§å¼‚å¸¸å¾å…†ï¼Œæå‰å‘ç°æ•…éšœå¯è·å¾—é¢å¤–åˆ†æ•°ï¼</p>

                    <!-- ä»ªè¡¨ç›˜ -->
                    <div class="gauge-row">
                        <div class="gauge" data-gauge-id="spd" onclick="monitorGauge('spd')">
                            <div class="gauge-label" data-i18n="gauge.spd">SPD</div>
                            <div class="gauge-needle" id="nd-spd"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="alt" onclick="monitorGauge('alt')">
                            <div class="gauge-label" data-i18n="gauge.alt">ALT</div>
                            <div class="gauge-needle" id="nd-alt"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="oil_p" onclick="monitorGauge('oil_p')">
                            <div class="oil-green"></div>
                            <div class="gauge-label" data-i18n="gauge.oil">OIL P</div>
                            <div class="gauge-needle" id="nd-oil"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="rpm" onclick="monitorGauge('rpm')">
                            <div class="gauge-label" data-i18n="gauge.rpm">RPM</div>
                            <div class="gauge-needle" id="nd-rpm"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="fuel_qty" onclick="monitorGauge('fuel_qty')">
                            <div class="gauge-label" data-i18n="gauge.fuel">FUEL</div>
                            <div class="gauge-needle" id="nd-fuel"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="vacuum" onclick="monitorGauge('vacuum')">
                            <div class="gauge-label" data-i18n="gauge.vac">VAC</div>
                            <div class="gauge-needle" id="nd-vacuum"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge" data-gauge-id="ammeter" onclick="monitorGauge('ammeter')">
                            <div class="gauge-label" data-i18n="gauge.amps">AMPS</div>
                            <div class="gauge-needle" id="nd-ammeter"></div>
                            <div class="gauge-center"></div>
                        </div>
                    </div>

                    <!-- è™šæ‹Ÿèˆªè·¯ -->
                    <div class="route-box" id="route-track">
                        <div class="route-line"></div>
                        <div class="route-text" style="left: 10px;">CYXH</div>
                        <div class="route-text" style="right: 10px;">CYYC</div>
                        <div id="plane-icon">âœˆï¸</div>
                    </div>
                    <p class="text-center small text-muted mt-1" id="route-legend" data-i18n="route.legend">Visualized Flight Progress</p>
                </div>

            </div>

            <!-- å³ä¾§ï¼šè¾…åŠ©åŒº -->
            <div class="col-md-4">
                <!-- å‘Šè­¦ -->
                <div id="alert-box" class="alert alert-dark text-center mb-3" data-i18n="alerts.normal">SYSTEM NORMAL</div>

                <!-- PM éªŒè¯é¢æ¿ (ä»… PM å¯è§) -->
                <div id="pm-verify-panel" class="panel border-info" style="display:none;">
                    <h6 class="text-info" id="pm-panel-title" data-i18n="pm.panel.title">ğŸ” PM éªŒè¯å†³ç­–</h6>
                    <div class="small mb-2">
                        <strong id="pm-plan-label" data-i18n="pm.panel.planLabel">PF æ–¹æ¡ˆï¼š</strong><br>
                        <span id="pm-pf-decision" class="text-warning"></span>
                    </div>

                    <div class="sop-panel" id="pm-sop-display">
                        <h6 id="pm-sop-title" data-i18n="pm.panel.sopTitle">SOP å‚è€ƒ</h6>
                        <ul id="pm-sop-content"></ul>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success" onclick="pmVerify(true)" id="pm-approve-btn" data-i18n="pm.panel.approve">âœ… åŒæ„æ–¹æ¡ˆ</button>
                        <button class="btn btn-danger" onclick="pmVerify(false)" id="pm-reject-btn" data-i18n="pm.panel.reject">âŒ é©³å›æ–¹æ¡ˆ</button>
                    </div>
                </div>

                <!-- QRH åº“ (Phase 3) - å¯æŠ˜å  -->
                <div class="collapsible-panel">
                    <div class="collapsible-header" onclick="toggleQRHPanel()">
                        <h6 id="qrh-header" data-i18n="qrh.header">ğŸ“š QRH Library (åº”æ€¥æ£€æŸ¥å•)</h6>
                        <span class="collapsible-icon" id="qrh-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="qrh-content">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm text-start qrh-button" onclick="selQRH('engine_fire')" data-i18n="qrh.engine_fire">ğŸ”¥ ENGINE FIRE</button>
                            <button class="btn btn-outline-warning btn-sm text-start qrh-button" onclick="selQRH('low_oil_pressure')" data-i18n="qrh.low_oil_pressure">ğŸ›¢ï¸ LOW OIL PRESSURE</button>
                            <button class="btn btn-outline-info btn-sm text-start qrh-button" onclick="selQRH('electrical_fire')" data-i18n="qrh.electrical_fire">âš¡ ELECTRICAL FIRE</button>
                            <button class="btn btn-outline-primary btn-sm text-start qrh-button" onclick="selQRH('carburetor_icing')" data-i18n="qrh.carburetor_icing">â„ï¸ CARBURETOR ICING</button>
                            <button class="btn btn-outline-success btn-sm text-start qrh-button" onclick="selQRH('fuel_imbalance')" data-i18n="qrh.fuel_imbalance">âš–ï¸ FUEL IMBALANCE</button>
                            <button class="btn btn-outline-secondary btn-sm text-start qrh-button" onclick="selQRH('vacuum_failure')" data-i18n="qrh.vacuum_failure">ğŸŒ€ VACUUM FAILURE</button>
                            <button class="btn btn-outline-light btn-sm text-start qrh-button" onclick="selQRH('alternator_failure')" data-i18n="qrh.alternator_failure">ğŸ”‹ ALTERNATOR FAILURE</button>
                        </div>
                    </div>
                </div>

                <!-- å½“å‰æ£€æŸ¥å• -->
                <div id="chk-panel" class="panel" style="display:none; border-color: #d63384;">
                    <h6 id="chk-title" class="text-danger fw-bold">TITLE</h6>
                    <div id="chk-msg" class="small mb-2"></div>
                    <div id="chk-list"></div>
                </div>

                <!-- å¯¹è¯é¢æ¿ -->
                <div class="panel p-2" style="height: 400px; display: flex; flex-direction: column;">
                    <h6 class="text-info mb-2" data-i18n="chat.title">ğŸ’¬ æœºç»„é€šä¿¡</h6>
                    <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; background: #1a1a2e; padding: 10px; border-radius: 4px; margin-bottom: 10px;"></div>
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="chat-input" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex: 1;" data-i18n-placeholder="chat.placeholder">
                        <button onclick="sendChatMessage()" class="btn btn-primary btn-sm" id="chat-send-btn" data-i18n="chat.send">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PF å†³ç­–æ¨¡æ€æ¡† -->
<div class="modal fade" id="pfDecisionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="pf-modal-title" data-i18n="pf.modal.title" data-i18n-mode="html">
                    <span class="badge bg-danger">PF</span> å¨èƒå†³ç­–
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong id="pf-threat-label" data-i18n="pf.modal.threat">å¨èƒï¼š</strong> <span id="pf-threat-keyword"></span><br>
                    <span id="pf-threat-desc"></span>
                </div>
                <h6 class="text-info" id="pf-options-title" data-i18n="pf.modal.options">é€‰æ‹©åº”å¯¹æ–¹æ¡ˆï¼š</h6>
                <div id="pf-options-list"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="pf-cancel-btn" data-i18n="pf.modal.cancel">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="pf-submit-btn" onclick="submitPFDecision()" data-i18n="pf.modal.submit">æäº¤æ–¹æ¡ˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- ç»“ç®—å¼¹çª— -->
<div class="modal fade" id="endModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-dark">
            <div class="modal-header"><h5 class="modal-title" id="end-modal-title" data-i18n="end.modal.title">è®­ç»ƒæŠ¥å‘Š</h5></div>
            <div class="modal-body text-center">
                <h1 class="text-success display-3" id="end-score">0</h1>
                <h4 id="end-res">Passed</h4>
                <p class="text-muted" id="end-sum">...</p>
            </div>
            <div class="modal-footer">
                <button onclick="location.reload()" class="btn btn-primary" id="end-modal-button" data-i18n="end.modal.button">End Session</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    let room = "";
    let myRole = "";
    let pfDecisionModal;
    let currentThreatKeyword = "";
    let selectedOptionId = "";

    const LANGUAGE_STORAGE_KEY = 'tem_app_lang';
    const translations = {
        zh: {
            'language.toggle': 'è¯­è¨€',
            'page.title': 'C172 TEM è®­ç»ƒå™¨ V2 - è§’è‰²åˆ†å·¥ç‰ˆ',
            'header.title': 'âœˆï¸ C172 TEM è®­ç»ƒå™¨ V2',
            'header.room_badge': 'æˆ¿é—´: {room}',
            'phase.badge.wait': 'å¾…å‘½',
            'phase.badge.phase1': 'Phase 1',
            'phase.badge.phase2': 'Phase 2: In-flight',
            'voice.toggle': 'ğŸ”Š è¯­éŸ³æ’­æŠ¥',
            'score.label': 'å¾—åˆ†',
            'login.title': 'é£è¡Œå‡†å¤‡',
            'login.mode.label': 'è®­ç»ƒæ¨¡å¼',
            'login.mode.dual': 'ğŸ§‘â€âœˆï¸ğŸ§‘â€âœˆï¸ åŒäººåä½œæ¨¡å¼ (2 äºº)',
            'login.mode.single': 'ğŸ§‘â€âœˆï¸ğŸ¤– å•äºº + AI æ¨¡å¼',
            'login.mode.note': 'å•äººæ¨¡å¼ï¼šAI å°†æ‰®æ¼”å¦ä¸€ä¸ªè§’è‰²ä¸ä½ åä½œè®­ç»ƒ',
            'login.room.label': 'è®­ç»ƒæˆ¿é—´å·',
            'login.room.placeholder': 'ä¾‹å¦‚: 8888',
            'login.room.note': 'å’Œä½ çš„æ­æ¡£è¾“å…¥ç›¸åŒçš„æˆ¿é—´å·',
            'login.username.label': 'å‘¼å·',
            'login.username.placeholder': 'ä¾‹å¦‚: Pilot A',
            'login.role.label': 'èŒè´£',
            'login.role.pf': 'PF (æ“çºµé£è¡Œå‘˜)',
            'login.role.pm': 'PM (ç›‘æ§é£è¡Œå‘˜)',
            'login.button': 'åŠ å…¥è®­ç»ƒ',
            'phase1.title': 'Phase 1: èµ·é£å‰ TEM (å¨èƒç®¡ç†)',
            'phase1.instructions': '<strong>PF</strong>: ç‚¹å‡»æ–‡æœ¬ä¸­çš„å¨èƒå…³é”®è¯ï¼Œé€‰æ‹©åº”å¯¹æ–¹æ¡ˆ<br><strong>PM</strong>: å®¡æ ¸ PF æ–¹æ¡ˆï¼ŒéªŒè¯ SOP é™åˆ¶å¹¶åšå‡ºå†³ç­–',
            'phase1.threatStatus.title': 'âœ… å·²å¤„ç†å¨èƒ',
            'phase1.quiz.title': 'ğŸ“š ç´§æ€¥é¢„æ¡ˆçŸ¥è¯†æµ‹è¯• (PM æ“ä½œ)',
            'phase1.quiz.button': 'å¼€å§‹ç´§æ€¥é¢„æ¡ˆæµ‹è¯•',
            'phase1.next.button': 'æ£€æŸ¥å®Œæ¯•ï¼Œå‡†å¤‡èµ·é£ (Cross-check)',
            'phase1.next.waiting': 'ç­‰å¾…å¯¹æ–¹ç¡®è®¤...',
            'phase2.title': 'Phase 2: In-flight (ç©ºä¸­å·¡èˆª)',
            'phase2.tip': 'ğŸ’¡ ç‚¹å‡»ä»ªè¡¨æ ‡è®°ç›‘æ§å¼‚å¸¸å¾å…†ï¼Œæå‰å‘ç°æ•…éšœå¯è·å¾—é¢å¤–åˆ†æ•°ï¼',
            'route.legend': 'èˆªè¿¹è¿›åº¦',
            'gauge.spd': 'ç©ºé€Ÿ',
            'gauge.alt': 'é«˜åº¦',
            'gauge.oil': 'æœºæ²¹å‹åŠ›',
            'gauge.rpm': 'è½¬é€Ÿ',
            'gauge.fuel': 'ç‡ƒæ²¹',
            'gauge.vac': 'çœŸç©º',
            'gauge.amps': 'ç”µæµ',
            'alerts.normal': 'SYSTEM NORMAL',
            'alerts.monitoring': 'MONITORING...',
            'pm.panel.title': 'ğŸ” PM éªŒè¯å†³ç­–',
            'pm.panel.planLabel': 'PF æ–¹æ¡ˆï¼š',
            'pm.panel.sopTitle': 'SOP å‚è€ƒ',
            'pm.panel.approve': 'âœ… åŒæ„æ–¹æ¡ˆ',
            'pm.panel.reject': 'âŒ é©³å›æ–¹æ¡ˆ',
            'qrh.header': 'ğŸ“š QRH åº“ (åº”æ€¥æ£€æŸ¥å•)',
            'qrh.engine_fire': 'ğŸ”¥ å‘åŠ¨æœºèµ·ç«',
            'qrh.low_oil_pressure': 'ğŸ›¢ï¸ æœºæ²¹å‹åŠ›è¿‡ä½',
            'qrh.electrical_fire': 'âš¡ ç”µæ°”ç«ç¾',
            'qrh.carburetor_icing': 'â„ï¸ åŒ–æ²¹å™¨ç»“å†°',
            'qrh.fuel_imbalance': 'âš–ï¸ ç‡ƒæ²¹ä¸å¹³è¡¡',
            'qrh.vacuum_failure': 'ğŸŒ€ çœŸç©ºç³»ç»Ÿæ•…éšœ',
            'qrh.alternator_failure': 'ğŸ”‹ å‘ç”µæœºæ•…éšœ',
            'chat.title': 'ğŸ’¬ æœºç»„é€šä¿¡',
            'chat.placeholder': 'è¾“å…¥æ¶ˆæ¯...',
            'chat.send': 'å‘é€',
            'quiz.questionLabel': 'é—®é¢˜ {number}:',
            'quiz.correct': 'âœ… æ­£ç¡®',
            'quiz.incorrect': 'âŒ é”™è¯¯',
            'pf.modal.title': '<span class="badge bg-danger">PF</span> å¨èƒå†³ç­–',
            'pf.modal.threat': 'å¨èƒï¼š',
            'pf.modal.options': 'é€‰æ‹©åº”å¯¹æ–¹æ¡ˆï¼š',
            'pf.modal.cancel': 'å–æ¶ˆ',
            'pf.modal.submit': 'æäº¤æ–¹æ¡ˆ',
            'end.modal.title': 'è®­ç»ƒæŠ¥å‘Š',
            'end.modal.button': 'ç»“æŸä¼šè¯',
            'alerts.enter_callsign': 'è¯·è¾“å…¥æ‚¨çš„å‘¼å·',
            'alerts.enter_room': 'è¯·è¾“å…¥æˆ¿é—´å· (ä¾‹å¦‚: 101)',
            'alerts.pf_only': 'åªæœ‰ PF å¯ä»¥è¯†åˆ«å¨èƒ',
            'alerts.select_option': 'è¯·é€‰æ‹©ä¸€ä¸ªåº”å¯¹æ–¹æ¡ˆ',
            'alerts.partner_left': 'âš ï¸ æ­æ¡£ {username} å·²ç¦»å¼€ï¼Œè®­ç»ƒæš‚åœã€‚è¯·ç­‰å¾…å…¶ä»–äººåŠ å…¥æˆ–åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚',
            'tooltips.clickThreat': 'ç‚¹å‡»è¯†åˆ«å¨èƒ',
            'log.voice_on': 'ğŸ”Š è¯­éŸ³æ’­æŠ¥å·²å¼€å¯',
            'log.voice_off': 'ğŸ”‡ è¯­éŸ³æ’­æŠ¥å·²å…³é—­',
            'log.phase1.start': 'èµ·é£å‰é˜¶æ®µå¼€å§‹ã€‚PFï¼šè¯†åˆ«å¨èƒï¼›PMï¼šç›‘æ§å¹¶éªŒè¯ã€‚',
            'log.pm.verify': 'ğŸ” PM: éªŒè¯ PF çš„æ–¹æ¡ˆ "{decision}"',
            'log.threats.complete': 'âœ… æ‰€æœ‰å¨èƒå·²å¤„ç†ï¼Œå¯ä»¥å¼€å§‹ç´§æ€¥é¢„æ¡ˆæµ‹è¯•',
            'log.quiz.start': 'ğŸ“š ç´§æ€¥é¢„æ¡ˆæµ‹è¯•å¼€å§‹ (PM æ“ä½œ)',
            'log.quiz.complete': 'âœ… æµ‹è¯•å®Œæˆï¼Œå¯ä»¥è¿›å…¥ Phase 2',
            'log.phase2.start': 'èµ·é£ï¼å¼€å§‹ç›‘æ§ä»ªè¡¨...',
            'log.check_item': '{role} å·²å‹¾é€‰ç¬¬ {index} é¡¹',
            'log.user_count': 'ğŸ‘¥ æˆ¿é—´äººæ•°: {count}/2 - {users}',
            'log.user_left': 'âš ï¸ {username} ({role}) ç¦»å¼€äº†è®­ç»ƒ - å‰©ä½™äººæ•°: {remaining}/2'
        },
        en: {
            'language.toggle': 'Language',
            'page.title': 'C172 TEM Trainer V2 - Crew Mode',
            'header.title': 'âœˆï¸ C172 TEM Trainer V2',
            'header.room_badge': 'Room: {room}',
            'phase.badge.wait': 'Standby',
            'phase.badge.phase1': 'Phase 1',
            'phase.badge.phase2': 'Phase 2: In-flight',
            'voice.toggle': 'ğŸ”Š Voice Output',
            'score.label': 'Score',
            'login.title': 'Flight Preparation',
            'login.mode.label': 'Training Mode',
            'login.mode.dual': 'ğŸ§‘â€âœˆï¸ğŸ§‘â€âœˆï¸ Two-player Crew Mode',
            'login.mode.single': 'ğŸ§‘â€âœˆï¸ğŸ¤– Single + AI Partner',
            'login.mode.note': 'Single mode: the AI will act as your crewmate.',
            'login.room.label': 'Room ID',
            'login.room.placeholder': 'e.g., 8888',
            'login.room.note': 'Enter the same room ID as your partner.',
            'login.username.label': 'Callsign',
            'login.username.placeholder': 'e.g., Pilot A',
            'login.role.label': 'Role',
            'login.role.pf': 'PF (Pilot Flying)',
            'login.role.pm': 'PM (Pilot Monitoring)',
            'login.button': 'Join Session',
            'phase1.title': 'Phase 1: Pre-flight TEM (Threat Management)',
            'phase1.instructions': '<strong>PF</strong>: Click threat keywords in the text and propose mitigations.<br><strong>PM</strong>: Review PF plans, validate SOP limits, and approve/deny.',
            'phase1.threatStatus.title': 'âœ… Processed Threats',
            'phase1.quiz.title': 'ğŸ“š Emergency Memory-Item Quiz (PM only)',
            'phase1.quiz.button': 'Start Emergency Quiz',
            'phase1.next.button': 'Check complete, ready for takeoff (Cross-check)',
            'phase1.next.waiting': 'Waiting for partner confirmation...',
            'phase2.title': 'Phase 2: In-flight (Cruise Monitoring)',
            'phase2.tip': 'ğŸ’¡ Click an instrument to tag abnormal precursors and earn bonus points.',
            'route.legend': 'Visualized Flight Progress',
            'gauge.spd': 'SPD',
            'gauge.alt': 'ALT',
            'gauge.oil': 'OIL P',
            'gauge.rpm': 'RPM',
            'gauge.fuel': 'FUEL',
            'gauge.vac': 'VAC',
            'gauge.amps': 'AMPS',
            'alerts.normal': 'SYSTEM NORMAL',
            'alerts.monitoring': 'MONITORING...',
            'pm.panel.title': 'ğŸ” PM Decision Review',
            'pm.panel.planLabel': 'PF Plan:',
            'pm.panel.sopTitle': 'SOP Reference',
            'pm.panel.approve': 'âœ… Approve Plan',
            'pm.panel.reject': 'âŒ Reject Plan',
            'qrh.header': 'ğŸ“š QRH Library (Emergency Checklists)',
            'qrh.engine_fire': 'ğŸ”¥ Engine Fire',
            'qrh.low_oil_pressure': 'ğŸ›¢ï¸ Low Oil Pressure',
            'qrh.electrical_fire': 'âš¡ Electrical Fire',
            'qrh.carburetor_icing': 'â„ï¸ Carburetor Icing',
            'qrh.fuel_imbalance': 'âš–ï¸ Fuel Imbalance',
            'qrh.vacuum_failure': 'ğŸŒ€ Vacuum Failure',
            'qrh.alternator_failure': 'ğŸ”‹ Alternator Failure',
            'chat.title': 'ğŸ’¬ Crew Communication',
            'chat.placeholder': 'Type a message...',
            'chat.send': 'Send',
            'quiz.questionLabel': 'Question {number}:',
            'quiz.correct': 'âœ… Correct',
            'quiz.incorrect': 'âŒ Incorrect',
            'pf.modal.title': '<span class="badge bg-danger">PF</span> Threat Decision',
            'pf.modal.threat': 'Threat:',
            'pf.modal.options': 'Select a response:',
            'pf.modal.cancel': 'Cancel',
            'pf.modal.submit': 'Submit Plan',
            'end.modal.title': 'Training Report',
            'end.modal.button': 'End Session',
            'alerts.enter_callsign': 'Please enter your callsign.',
            'alerts.enter_room': 'Please enter a room ID (e.g., 101).',
            'alerts.pf_only': 'Only the PF can identify threats.',
            'alerts.select_option': 'Please select a response option.',
            'alerts.partner_left': 'âš ï¸ Partner {username} left the session. Training pausedâ€”wait for another member or refresh to restart.',
            'tooltips.clickThreat': 'Click to identify threat',
            'log.voice_on': 'ğŸ”Š Voice playback enabled',
            'log.voice_off': 'ğŸ”‡ Voice playback disabled',
            'log.phase1.start': 'Pre-flight phase started. PF: identify threats; PM: monitor and verify.',
            'log.pm.verify': 'ğŸ” PM: Reviewing PF decision "{decision}"',
            'log.threats.complete': 'âœ… All threats handled. Emergency quiz unlocked.',
            'log.quiz.start': 'ğŸ“š Emergency quiz started (PM action)',
            'log.quiz.complete': 'âœ… Quiz complete. Ready for Phase 2.',
            'log.phase2.start': 'Takeoff! Start monitoring instruments...',
            'log.check_item': '{role} checked checklist item {index}',
            'log.user_count': 'ğŸ‘¥ Room members: {count}/2 - {users}',
            'log.user_left': 'âš ï¸ {username} ({role}) left the session - remaining: {remaining}/2'
        }
    };
    let currentLang = localStorage.getItem(LANGUAGE_STORAGE_KEY) || 'zh';

    const dynamicTextMap = {
        "METAR": { zh: "METAR æƒ…æŠ¥", en: "METAR" },
        "Aircraft": { zh: "é£æœºçŠ¶æ€", en: "Aircraft" },
        "Pilot": { zh: "æœºç»„çŠ¶æ€", en: "Pilot" },
        "METAR æ˜¾ç¤ºé˜µé£ 25 èŠ‚ï¼Œå¯èƒ½è¶…å‡ºä¾§é£é™åˆ¶": {
            zh: "METAR æ˜¾ç¤ºé˜µé£ 25 èŠ‚ï¼Œå¯èƒ½è¶…å‡ºä¾§é£é™åˆ¶",
            en: "METAR indicates gusting 25 kt, possibly exceeding crosswind limits"
        },
        "ä½¿ç”¨ä¾§é£èµ·é£æ ‡å‡†ç¨‹åº": {
            zh: "ä½¿ç”¨ä¾§é£èµ·é£æ ‡å‡†ç¨‹åº",
            en: "Apply the standard crosswind takeoff procedure"
        },
        "ç­‰å¾…é£å†µæ”¹å–„åèµ·é£": {
            zh: "ç­‰å¾…é£å†µæ”¹å–„åèµ·é£",
            en: "Delay departure until winds improve"
        },
        "å¿½ç•¥ä¾§é£å½±å“ï¼Œæ­£å¸¸èµ·é£": {
            zh: "å¿½ç•¥ä¾§é£å½±å“ï¼Œæ­£å¸¸èµ·é£",
            en: "Ignore the crosswind and depart normally"
        },
        "C172 ä¾§é£é™åˆ¶": { zh: "C172 ä¾§é£é™åˆ¶", en: "C172 Crosswind Limits" },
        "æœ€å¤§æ¼”ç¤ºä¾§é£é™åˆ¶: 15 èŠ‚": {
            zh: "æœ€å¤§æ¼”ç¤ºä¾§é£é™åˆ¶: 15 èŠ‚",
            en: "Demonstrated crosswind limit: 15 kt"
        },
        "å½“å‰é˜µé£: 25 èŠ‚": { zh: "å½“å‰é˜µé£: 25 èŠ‚", en: "Current gusts: 25 kt" },
        "çŠ¶æ€: âš ï¸ è¶…å‡ºé™åˆ¶": { zh: "çŠ¶æ€: âš ï¸ è¶…å‡ºé™åˆ¶", en: "Status: âš ï¸ Beyond limit" },
        "å»ºè®®: ç­‰å¾…é£å†µæ”¹å–„æˆ–ä½¿ç”¨ä¾§é£ç¨‹åº": {
            zh: "å»ºè®®: ç­‰å¾…é£å†µæ”¹å–„æˆ–ä½¿ç”¨ä¾§é£ç¨‹åº",
            en: "Advisory: Wait for better winds or use crosswind procedures"
        },
        "ç€é™†ç¯æ•…éšœï¼ˆLanding Light Unserviceableï¼‰": {
            zh: "ç€é™†ç¯æ•…éšœï¼ˆLanding Light Unserviceableï¼‰",
            en: "Landing light inoperative"
        },
        "æŸ¥é˜… MELï¼Œç¡®è®¤å¯æ”¾è¡Œæ¡ä»¶": {
            zh: "æŸ¥é˜… MELï¼Œç¡®è®¤å¯æ”¾è¡Œæ¡ä»¶",
            en: "Consult the MEL to confirm dispatch conditions"
        },
        "ç™½å¤©é£è¡Œæ— å½±å“ï¼Œç»§ç»­èµ·é£": {
            zh: "ç™½å¤©é£è¡Œæ— å½±å“ï¼Œç»§ç»­èµ·é£",
            en: "Day VFR is acceptable, continue departure"
        },
        "æ¨è¿Ÿèˆªç­ï¼Œç­‰å¾…ç»´ä¿®": {
            zh: "æ¨è¿Ÿèˆªç­ï¼Œç­‰å¾…ç»´ä¿®",
            en: "Delay the flight and wait for maintenance"
        },
        "MEL ç€é™†ç¯æ¡æ¬¾": {
            zh: "MEL ç€é™†ç¯æ¡æ¬¾",
            en: "MEL Landing Light Section"
        },
        "ç€é™†ç¯æ•…éšœæ”¾è¡Œæ¡ä»¶:": {
            zh: "ç€é™†ç¯æ•…éšœæ”¾è¡Œæ¡ä»¶:",
            en: "Dispatch criteria for landing light failure:"
        },
        "âœ… æ—¥é—´ VFR: å¯æ”¾è¡Œ": { zh: "âœ… æ—¥é—´ VFR: å¯æ”¾è¡Œ", en: "âœ… Day VFR: allowed" },
        "âŒ å¤œé—´æˆ– IFR: å¿…é¡»å·¥ä½œ": {
            zh: "âŒ å¤œé—´æˆ– IFR: å¿…é¡»å·¥ä½œ",
            en: "âŒ Night or IFR: must be serviceable"
        },
        "å½“å‰æ¡ä»¶: æ—¥é—´ VFR (1800Z)": {
            zh: "å½“å‰æ¡ä»¶: æ—¥é—´ VFR (1800Z)",
            en: "Current condition: Day VFR (1800Z)"
        },
        "ç»“è®º: å¯æ”¾è¡Œï¼Œéœ€è®°å½•": {
            zh: "ç»“è®º: å¯æ”¾è¡Œï¼Œéœ€è®°å½•",
            en: "Conclusion: Dispatch allowed, log the defect"
        },
        "å‰¯é©¾é©¶èº«ä½“çŠ¶æ€ï¼šæ„Ÿå†’æ¢å¤ä¸­": {
            zh: "å‰¯é©¾é©¶èº«ä½“çŠ¶æ€ï¼šæ„Ÿå†’æ¢å¤ä¸­",
            en: "Copilot recovering from a cold"
        },
        "æ‰§è¡Œ IMSAFE æ£€æŸ¥ï¼Œè¯„ä¼°é€‚èˆªæ€§": {
            zh: "æ‰§è¡Œ IMSAFE æ£€æŸ¥ï¼Œè¯„ä¼°é€‚èˆªæ€§",
            en: "Run an IMSAFE check to assess fitness"
        },
        "ç®€å•èˆªçº¿æ— å½±å“ï¼Œç»§ç»­": {
            zh: "ç®€å•èˆªçº¿æ— å½±å“ï¼Œç»§ç»­",
            en: "Simple route has no impact, continue"
        },
        "é£è¡Œä¸­æŒç»­ç›‘æ§èº«ä½“çŠ¶æ€": {
            zh: "é£è¡Œä¸­æŒç»­ç›‘æ§èº«ä½“çŠ¶æ€",
            en: "Monitor physiological condition during flight"
        },
        "IMSAFE æ£€æŸ¥": { zh: "IMSAFE æ£€æŸ¥", en: "IMSAFE Checklist" },
        "I - Illness (ç–¾ç—…)": { zh: "I - ç–¾ç—… (Illness)", en: "I - Illness" },
        "M - Medication (è¯ç‰©)": { zh: "M - è¯ç‰© (Medication)", en: "M - Medication" },
        "S - Stress (å‹åŠ›)": { zh: "S - å‹åŠ› (Stress)", en: "S - Stress" },
        "A - Alcohol (é…’ç²¾)": { zh: "A - é…’ç²¾ (Alcohol)", en: "A - Alcohol" },
        "F - Fatigue (ç–²åŠ³)": { zh: "F - ç–²åŠ³ (Fatigue)", en: "F - Fatigue" },
        "E - Eating (é¥®é£Ÿ)": { zh: "E - é¥®é£Ÿ (Eating)", en: "E - Eating" },
        "âš ï¸ æ„Ÿå†’å¯èƒ½å½±å“åˆ¤æ–­åŠ›å’Œååº”æ—¶é—´": {
            zh: "âš ï¸ æ„Ÿå†’å¯èƒ½å½±å“åˆ¤æ–­åŠ›å’Œååº”æ—¶é—´",
            en: "âš ï¸ A cold can affect judgement and reaction time"
        },
        "ç¦»åœ°åï¼Œå¦‚æœå¼•æ“å¤±æ•ˆä¸”é«˜åº¦ä½äºå¤šå°‘è‹±å°ºï¼Œä¸¥ç¦æ‰å¤´ï¼Ÿ": {
            zh: "ç¦»åœ°åï¼Œå¦‚æœå¼•æ“å¤±æ•ˆä¸”é«˜åº¦ä½äºå¤šå°‘è‹±å°ºï¼Œä¸¥ç¦æ‰å¤´ï¼Ÿ",
            en: "After liftoff, below what altitude is a turnback prohibited if the engine fails?"
        },
        "200 è‹±å°º": { zh: "200 è‹±å°º", en: "200 ft" },
        "500 è‹±å°º": { zh: "500 è‹±å°º", en: "500 ft" },
        "1000 è‹±å°º": { zh: "1000 è‹±å°º", en: "1000 ft" },
        "1500 è‹±å°º": { zh: "1500 è‹±å°º", en: "1500 ft" },
        "æ ‡å‡†ç¨‹åºï¼š500 è‹±å°ºä»¥ä¸‹ç›´çº¿è¿«é™ï¼Œé¿å…å¤±é€Ÿèºæ—‹": {
            zh: "æ ‡å‡†ç¨‹åºï¼š500 è‹±å°ºä»¥ä¸‹ç›´çº¿è¿«é™ï¼Œé¿å…å¤±é€Ÿèºæ—‹",
            en: "Standard: Below 500 ft land straight ahead to avoid stall-spin"
        },
        "å‘ç°å¼•æ“ç«è­¦æ—¶ï¼Œç¬¬ä¸€è®°å¿†é¡¹ç›®æ˜¯ï¼Ÿ": {
            zh: "å‘ç°å¼•æ“ç«è­¦æ—¶ï¼Œç¬¬ä¸€è®°å¿†é¡¹ç›®æ˜¯ï¼Ÿ",
            en: "When an engine fire is detected, what is the first memory item?"
        },
        "å…³é—­ä¸»ç”µé—¨": { zh: "å…³é—­ä¸»ç”µé—¨", en: "Master switch - OFF" },
        "æ··åˆæ¯” - CUTOFF": { zh: "æ··åˆæ¯” - CUTOFF", en: "Mixture - CUTOFF" },
        "æ‰“å¼€ç­ç«å™¨": { zh: "æ‰“å¼€ç­ç«å™¨", en: "Fire extinguisher - ACTIVATE" },
        "å®£å¸ƒ MAYDAY": { zh: "å®£å¸ƒ MAYDAY", en: "Declare MAYDAY" },
        "å¼•æ“ç«è­¦é¦–è¦åŠ¨ä½œï¼šåˆ‡æ–­ç‡ƒæ²¹ä¾›åº”": {
            zh: "å¼•æ“ç«è­¦é¦–è¦åŠ¨ä½œï¼šåˆ‡æ–­ç‡ƒæ²¹ä¾›åº”",
            en: "Engine fire: first cut the fuel supply"
        },
        "ç”µæ°”ç«ç¾çš„æ ‡å‡†å¤„ç½®ç¨‹åºä¸­ï¼Œç¬¬ä¸€æ­¥æ˜¯ï¼Ÿ": {
            zh: "ç”µæ°”ç«ç¾çš„æ ‡å‡†å¤„ç½®ç¨‹åºä¸­ï¼Œç¬¬ä¸€æ­¥æ˜¯ï¼Ÿ",
            en: "What is the first step in the electrical fire procedure?"
        },
        "æ‰“å¼€æ‰€æœ‰é€šé£å£": { zh: "æ‰“å¼€æ‰€æœ‰é€šé£å£", en: "Open all vents" },
        "å…³é—­ä¸»ç”µé—¨ (Master Switch OFF)": {
            zh: "å…³é—­ä¸»ç”µé—¨ (Master Switch OFF)",
            en: "Master switch - OFF"
        },
        "é™ä½é«˜åº¦": { zh: "é™ä½é«˜åº¦", en: "Descend" },
        "ä½¿ç”¨ç­ç«å™¨": { zh: "ä½¿ç”¨ç­ç«å™¨", en: "Use fire extinguisher" },
        "ç”µæ°”ç«ç¾é¦–è¦ï¼šåˆ‡æ–­ç”µæº": {
            zh: "ç”µæ°”ç«ç¾é¦–è¦ï¼šåˆ‡æ–­ç”µæº",
            en: "Electrical fire: first cut power"
        },
        "LOW OIL PRESSURE": { zh: "æœºæ²¹å‹åŠ›ä½", en: "LOW OIL PRESSURE" },
        "Throttle - REDUCE": { zh: "æ²¹é—¨ - å‡å°", en: "Throttle - REDUCE" },
        "Landing Area - SELECT": { zh: "ç€é™†åœº - é€‰æ‹©", en: "Landing Area - SELECT" },
        "Prepare - FOR ENGINE FAILURE": {
            zh: "å‡†å¤‡ - æŒ‰å‘åŠ¨æœºå¤±æ•ˆå¤„ç½®",
            en: "Prepare - FOR ENGINE FAILURE"
        },
        "ENGINE FIRE IN FLIGHT": { zh: "ç©ºä¸­å‘åŠ¨æœºèµ·ç«", en: "ENGINE FIRE IN FLIGHT" },
        "Mixture - CUTOFF": { zh: "æ··åˆæ¯” - åˆ‡æ–­", en: "Mixture - CUTOFF" },
        "Fuel Valve - OFF": { zh: "ç‡ƒæ²¹é˜€ - å…³é—­", en: "Fuel Valve - OFF" },
        "Master Switch - OFF": { zh: "ä¸»ç”µé—¨ - å…³é—­", en: "Master Switch - OFF" },
        "Cabin Heat - OFF": { zh: "åº§èˆ±åŠ æ¸© - å…³é—­", en: "Cabin Heat - OFF" },
        "Airspeed - 105 KIAS": { zh: "ç©ºé€Ÿ - 105 KIAS", en: "Airspeed - 105 KIAS" },
        "ELECTRICAL FIRE": { zh: "ç”µæ°”ç«ç¾", en: "ELECTRICAL FIRE" },
        "Vents/Cabin Air - CLOSED": {
            zh: "é€šé£/åº§èˆ±ç©ºæ°” - å…³é—­",
            en: "Vents/Cabin Air - CLOSED"
        },
        "Fire Extinguisher - ACTIVATE": {
            zh: "ç­ç«å™¨ - å¯åŠ¨",
            en: "Fire Extinguisher - ACTIVATE"
        },
        "Avionics - OFF": { zh: "èˆªç”µ - å…³é—­", en: "Avionics - OFF" },
        "CARBURETOR ICING": { zh: "åŒ–æ²¹å™¨ç»“å†°", en: "CARBURETOR ICING" },
        "Carburetor Heat - FULL ON": {
            zh: "åŒ–æ²¹å™¨åŠ çƒ­ - å…¨å¼€",
            en: "Carburetor Heat - FULL ON"
        },
        "Throttle - OPEN slowly": { zh: "æ²¹é—¨ - ç¼“æ…¢æ¨è¿›", en: "Throttle - OPEN slowly" },
        "Monitor - RPM RECOVERY": { zh: "ç›‘æ§ - RPM æ¢å¤", en: "Monitor - RPM RECOVERY" },
        "Mixture - ADJUST": { zh: "æ··åˆæ¯” - è°ƒæ•´", en: "Mixture - ADJUST" },
        "FUEL IMBALANCE": { zh: "ç‡ƒæ²¹ä¸å¹³è¡¡", en: "FUEL IMBALANCE" },
        "Fuel Selector - SWITCH to fuller tank": {
            zh: "ç‡ƒæ²¹é€‰æ‹©é˜€ - è½¬è‡³æ²¹é‡è¾ƒå¤šçš„ä¸€ä¾§",
            en: "Fuel Selector - SWITCH to fuller tank"
        },
        "Cross-feed - OPEN (if available)": {
            zh: "äº¤è¾“ - æ‰“å¼€ï¼ˆå¦‚å¯ç”¨ï¼‰",
            en: "Cross-feed - OPEN (if available)"
        },
        "Monitor - FUEL QTY": { zh: "ç›‘æ§ - ç‡ƒæ²¹é‡", en: "Monitor - FUEL QTY" },
        "Plan - EARLY LANDING if severe": {
            zh: "è®¡åˆ’ - æƒ…å†µä¸¥é‡åˆ™æå‰è½åœ°",
            en: "Plan - EARLY LANDING if severe"
        },
        "VACUUM SYSTEM FAILURE": { zh: "çœŸç©ºç³»ç»Ÿæ•…éšœ", en: "VACUUM SYSTEM FAILURE" },
        "Verify - ATTITUDE INDICATOR unreliable": {
            zh: "ç¡®è®¤ - å§¿æ€ä»ªä¸å¯é ",
            en: "Verify - ATTITUDE INDICATOR unreliable"
        },
        "Use - TURN COORDINATOR for bank": {
            zh: "ä½¿ç”¨ - è½¬å¼¯åè°ƒä»ªæ§åˆ¶å€¾æ–œ",
            en: "Use - TURN COORDINATOR for bank"
        },
        "Refer - MAGNETIC COMPASS": {
            zh: "å‚è€ƒ - ç£ç½—ç›˜",
            en: "Refer - MAGNETIC COMPASS"
        },
        "Avoid - IMC if possible": {
            zh: "é¿å… - å¦‚å¯è¡Œé¿å…è¿›å…¥ä»ªè¡¨æ°”è±¡æ¡ä»¶",
            en: "Avoid - IMC if possible"
        },
        "ALTERNATOR FAILURE": { zh: "äº¤æµå‘ç”µæœºå¤±æ•ˆ", en: "ALTERNATOR FAILURE" },
        "Alternator - CYCLE (OFF then ON)": {
            zh: "äº¤æµå‘ç”µæœº - å¾ªç¯ï¼ˆå…³å†å¼€ï¼‰",
            en: "Alternator - CYCLE (OFF then ON)"
        },
        "If no recovery - SHED LOAD": {
            zh: "è‹¥æ— æ¢å¤ - å‡è½½",
            en: "If no recovery - SHED LOAD"
        },
        "Avionics - MINIMIZE": { zh: "èˆªç”µ - æœ€å°åŒ–", en: "Avionics - MINIMIZE" },
        "Battery - MONITOR voltage": {
            zh: "ç”µæ±  - ç›‘æ§ç”µå‹",
            en: "Battery - MONITOR voltage"
        },
        "Plan - NEAREST AIRPORT": {
            zh: "è®¡åˆ’ - å°±è¿‘æœºåœº",
            en: "Plan - NEAREST AIRPORT"
        }
    };

    function getTranslation(lang, key) {
        return translations[lang]?.[key] ?? translations.zh[key] ?? key;
    }

    function formatTranslation(template, params) {
        if (!template || typeof template !== 'string') return template;
        return template.replace(/\{(\w+)\}/g, (_, k) => (params && params[k] !== undefined ? params[k] : ''));
    }

    function t(key, params = {}, lang = currentLang) {
        const template = getTranslation(lang, key);
        return formatTranslation(template, params);
    }

    function translateElement(el, lang = currentLang) {
        if (!el) return;
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const mode = el.getAttribute('data-i18n-mode') || 'text';
        let params = {};
        if (el.dataset.i18nParams) {
            try {
                params = JSON.parse(el.dataset.i18nParams);
            } catch (error) {
                params = {};
            }
        }
        const value = t(key, params, lang);
        if (mode === 'html') {
            el.innerHTML = value;
        } else {
            el.textContent = value;
        }
    }

    function translatePlaceholder(el, lang = currentLang) {
        if (!el) return;
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        let params = {};
        if (el.dataset.i18nPlaceholderParams) {
            try {
                params = JSON.parse(el.dataset.i18nPlaceholderParams);
            } catch (error) {
                params = {};
            }
        }
        el.setAttribute('placeholder', t(key, params, lang));
    }

    function setDynamicTranslation(el, key, params = {}, mode = 'text') {
        if (!el) return;
        el.setAttribute('data-i18n', key);
        if (mode === 'html') {
            el.setAttribute('data-i18n-mode', 'html');
        } else {
            el.removeAttribute('data-i18n-mode');
        }
        if (params && Object.keys(params).length > 0) {
            el.dataset.i18nParams = JSON.stringify(params);
        } else if (el.dataset.i18nParams) {
            delete el.dataset.i18nParams;
        }
        translateElement(el);
    }

    function clearElementTranslation(el) {
        if (!el) return;
        el.removeAttribute('data-i18n');
        el.removeAttribute('data-i18n-mode');
        if (el.dataset.i18nParams) delete el.dataset.i18nParams;
    }

    function translateDynamicText(text, lang = currentLang) {
        if (text === undefined || text === null) return text;
        const key = String(text).trim();
        const entry = dynamicTextMap[key];
        if (!entry) return text;
        if (lang === 'en' && entry.en) return entry.en;
        if (lang === 'zh' && entry.zh) return entry.zh;
        return entry.en || entry.zh || text;
    }

    function translateDynamicArray(lines = [], lang = currentLang) {
        return lines.map(line => translateDynamicText(line, lang));
    }

    function applyLanguage(lang = currentLang) {
        currentLang = lang;
        localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);
        document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
        document.title = t('page.title', {}, lang);
        const selector = document.getElementById('language-select');
        if (selector) selector.value = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => translateElement(el, lang));
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => translatePlaceholder(el, lang));
    }

    function handleLanguageChange(lang) {
        applyLanguage(lang);
    }

    // è¯­éŸ³æ’­æ”¾ç›¸å…³å˜é‡
    let voiceEnabled = false;  // è¯­éŸ³å¼€å…³çŠ¶æ€
    let audioQueue = {};       // éŸ³é¢‘æ’­æ”¾é˜Ÿåˆ— {messageId: {index: audio_base64}}
    let isPlaying = false;     // æ˜¯å¦æ­£åœ¨æ’­æ”¾
    let messageCounter = 0;    // æ¶ˆæ¯è®¡æ•°å™¨ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€ID
    let currentPlayingMessage = null;  // å½“å‰æ­£åœ¨æ’­æ”¾çš„æ¶ˆæ¯ID
    let currentPlayingIndex = 0;       // å½“å‰æ­£åœ¨æ’­æ”¾çš„å¥å­ç´¢å¼•
    let pendingAudioCount = {};        // æ¯æ¡æ¶ˆæ¯å¾…æ¥æ”¶çš„éŸ³é¢‘æ•°é‡

    // å¨èƒå…³é”®è¯åˆ—è¡¨ (ä»åç«¯ PHASE1_THREATS åŒæ­¥)
    const THREAT_KEYWORDS = ["24015G25KT", "Landing_Light_U/S", "Recovering_from_Cold"];

    // è¯­éŸ³å¼€å…³åˆ‡æ¢
    function toggleVoice() {
        voiceEnabled = document.getElementById('voice-toggle').checked;
        console.log(`è¯­éŸ³æ’­æŠ¥: ${voiceEnabled ? 'å¼€å¯' : 'å…³é—­'}`);

        if (voiceEnabled) {
            log(t('log.voice_on'));
        } else {
            log(t('log.voice_off'));
        }
    }

    // åˆ†å‰²å¥å­ï¼ˆä¸­è‹±æ–‡æ”¯æŒï¼‰
    function splitSentences(text) {
        // ä½¿ç”¨æ­£åˆ™åˆ†å‰²å¥å­ï¼Œä¿ç•™åˆ†éš”ç¬¦
        const pattern = /([ã€‚ï¼ï¼Ÿ.!?\n]+)/;
        const parts = text.split(pattern);

        // é‡æ–°ç»„åˆå¥å­
        const sentences = [];
        for (let i = 0; i < parts.length - 1; i += 2) {
            if (i + 1 < parts.length) {
                const sentence = (parts[i] + parts[i + 1]).trim();
                if (sentence) sentences.push(sentence);
            } else if (parts[i].trim()) {
                sentences.push(parts[i].trim());
            }
        }

        // æ·»åŠ æœ€åä¸€ä¸ªéƒ¨åˆ†
        if (parts.length % 2 === 1 && parts[parts.length - 1].trim()) {
            sentences.push(parts[parts.length - 1].trim());
        }

        // å¦‚æœæ²¡æœ‰åˆ†å‰²æˆåŠŸï¼Œè¿”å›åŸæ–‡æœ¬ä½œä¸ºä¸€ä¸ªå¥å­
        if (sentences.length === 0 && text.trim()) {
            sentences.push(text.trim());
        }

        return sentences;
    }

    // è¯·æ±‚TTSï¼ˆæµå¼å¤„ç†ï¼šæŒ‰å¥å­å¹¶è¡Œè¯·æ±‚ï¼‰
    function requestTTS(text, messageId) {
        if (!voiceEnabled || !text || text.trim() === '') return;

        // æ¸…ç†ç‰¹æ®Šå­—ç¬¦å’Œemoji
        let cleanText = text.replace(/[ğŸ””âœ…âŒâš ï¸â³ğŸ”ŠğŸ”‡ğŸ‘¥ğŸ“šğŸ’¬ğŸ¤–ğŸ‘¤ğŸ”¥ğŸ›¢ï¸âš¡â„ï¸âš–ï¸ğŸŒ€ğŸ”‹]/g, '').trim();
        if (!cleanText) return;

        // åˆ†å‰²æˆå¥å­
        const sentences = splitSentences(cleanText);
        console.log(`[TTS] åˆ†å‰²ä¸º ${sentences.length} ä¸ªå¥å­`);

        if (sentences.length === 0) return;

        // åˆå§‹åŒ–è¯¥æ¶ˆæ¯çš„éŸ³é¢‘å­˜å‚¨
        audioQueue[messageId] = {};
        pendingAudioCount[messageId] = sentences.length;

        // å¹¶è¡Œè¯·æ±‚æ¯ä¸ªå¥å­çš„TTS
        sentences.forEach((sentence, index) => {
            console.log(`[TTS] è¯·æ±‚å¥å­ #${index}: ${sentence.substring(0, 20)}...`);

            socket.emit('request_tts', {
                room: room,
                text: sentence,
                message_id: messageId,
                sentence_index: index,
                total_sentences: sentences.length
            });
        });

        // å¦‚æœæ²¡æœ‰æ­£åœ¨æ’­æ”¾ï¼Œå¼€å§‹æ’­æ”¾è¿™æ¡æ¶ˆæ¯
        if (!isPlaying) {
            currentPlayingMessage = messageId;
            currentPlayingIndex = 0;
            tryPlayNext();
        }
    }

    // æ¥æ”¶TTSéŸ³é¢‘æ•°æ®
    socket.on('tts_audio', (data) => {
        if (!voiceEnabled) return;

        const messageId = data.message_id;
        const sentenceIndex = data.sentence_index;

        console.log(`[TTS] æ”¶åˆ°éŸ³é¢‘: æ¶ˆæ¯=${messageId}, å¥å­=${sentenceIndex}`);

        // å­˜å‚¨éŸ³é¢‘æ•°æ®
        if (!audioQueue[messageId]) {
            audioQueue[messageId] = {};
        }
        audioQueue[messageId][sentenceIndex] = data.audio_base64;

        // å‡å°‘å¾…æ¥æ”¶è®¡æ•°
        if (pendingAudioCount[messageId]) {
            pendingAudioCount[messageId]--;
        }

        // å°è¯•æ’­æ”¾ä¸‹ä¸€ä¸ª
        tryPlayNext();
    });

    // å°è¯•æ’­æ”¾ä¸‹ä¸€ä¸ªéŸ³é¢‘
    function tryPlayNext() {
        if (isPlaying) return;

        // æ£€æŸ¥å½“å‰æ¶ˆæ¯çš„å½“å‰å¥å­æ˜¯å¦å·²å‡†å¤‡å¥½
        if (currentPlayingMessage &&
            audioQueue[currentPlayingMessage] &&
            audioQueue[currentPlayingMessage][currentPlayingIndex] !== undefined) {

            playAudio(
                audioQueue[currentPlayingMessage][currentPlayingIndex],
                currentPlayingMessage,
                currentPlayingIndex
            );
        }
    }

    // æ’­æ”¾éŸ³é¢‘
    function playAudio(audioBase64, messageId, sentenceIndex) {
        isPlaying = true;

        console.log(`[TTS] æ’­æ”¾: æ¶ˆæ¯=${messageId}, å¥å­=${sentenceIndex}`);

        // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
        const audio = new Audio(`data:audio/mp3;base64,${audioBase64}`);

        audio.onended = () => {
            console.log(`[TTS] æ’­æ”¾å®Œæˆ: å¥å­=${sentenceIndex}`);
            isPlaying = false;

            // åˆ é™¤å·²æ’­æ”¾çš„éŸ³é¢‘æ•°æ®
            if (audioQueue[messageId]) {
                delete audioQueue[messageId][sentenceIndex];
            }

            // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¥å­
            currentPlayingIndex++;

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå¥å­
            if (audioQueue[messageId] && Object.keys(audioQueue[messageId]).length > 0) {
                // ç»§ç»­æ’­æ”¾å½“å‰æ¶ˆæ¯çš„ä¸‹ä¸€ä¸ªå¥å­
                tryPlayNext();
            } else {
                // å½“å‰æ¶ˆæ¯æ’­æ”¾å®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                delete audioQueue[messageId];
                delete pendingAudioCount[messageId];

                // æŸ¥æ‰¾ä¸‹ä¸€æ¡å¾…æ’­æ”¾çš„æ¶ˆæ¯
                const nextMessageId = Object.keys(audioQueue).find(id =>
                    Object.keys(audioQueue[id]).length > 0
                );

                if (nextMessageId) {
                    currentPlayingMessage = nextMessageId;
                    currentPlayingIndex = 0;
                    tryPlayNext();
                } else {
                    currentPlayingMessage = null;
                    currentPlayingIndex = 0;
                }
            }
        };

        audio.onerror = (e) => {
            console.error('[TTS] éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
            isPlaying = false;
            currentPlayingIndex++;
            tryPlayNext();
        };

        // å¼€å§‹æ’­æ”¾
        audio.play().catch(e => {
            console.error('[TTS] æ— æ³•æ’­æ”¾éŸ³é¢‘:', e);
            isPlaying = false;
            currentPlayingIndex++;
            tryPlayNext();
        });
    }

    // 1. ç™»å½•
    function join() {
        const u = document.getElementById('username').value;
        const r = document.getElementById('role').value;
        const inputRoom = document.getElementById('room-id').value;
        const mode = document.getElementById('mode').value;  // æ–°å¢ï¼šè·å–è®­ç»ƒæ¨¡å¼

        if(!u) return alert(t('alerts.enter_callsign'));
        if(!inputRoom) return alert(t('alerts.enter_room'));

        room = inputRoom;
        myRole = r;

        socket.emit('join', {
            username: u,
            role: r,
            room: room,
            mode: mode  // æ–°å¢ï¼šå‘é€è®­ç»ƒæ¨¡å¼
        });
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('sim-area').style.display = 'block';

        const roomBadge = document.getElementById('room-badge');
        if (roomBadge) {
            roomBadge.style.display = 'inline-block';
            setDynamicTranslation(roomBadge, 'header.room_badge', {room});
        }

        // æ˜¾ç¤ºè§’è‰²æ ‡è¯†
        const roleBadge = document.getElementById('my-role-badge');
        roleBadge.innerText = myRole;
        roleBadge.className = myRole === 'PF' ? 'badge role-badge-pf' : 'badge role-badge-pm';

        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        pfDecisionModal = new bootstrap.Modal(document.getElementById('pfDecisionModal'));
    }

    // 2. æ¸²æŸ“ Phase 1 æ–‡å­—
    socket.on('start_phase_1', (payload) => {
        setDynamicTranslation(document.getElementById('phase-badge'), 'phase.badge.phase1');
        document.getElementById('phase-badge').className = "badge bg-info";
        const box = document.getElementById('preflight-content');
        box.innerHTML = "";

        payload.data.forEach(item => {
            const row = document.createElement('div');
            const label = document.createElement('span');
            label.className = 'tem-label';
            label.innerText = `${translateDynamicText(item.label)}:`;
            row.appendChild(label);

            // åˆ†è¯æ¸²æŸ“ï¼Œå¨èƒå…³é”®è¯ä¸é«˜äº®ï¼ˆè®©å­¦å‘˜è‡ªå·±è¯†åˆ«ï¼‰
            item.content.split(' ').forEach(word => {
                const span = document.createElement('span');
                span.className = "tem-word";
                span.innerText = word;

                // å¦‚æœæ˜¯å¨èƒå…³é”®è¯ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ä½†ä¸é«˜äº®
                if (THREAT_KEYWORDS.includes(word)) {
                    // åªæœ‰ PF å¯ä»¥ç‚¹å‡»
                    if (myRole === 'PF') {
                        span.onclick = () => identifyThreat(word);
                        span.title = t('tooltips.clickThreat');
                    }
                } else {
                    // éå¨èƒè¯ä¸å¯ç‚¹å‡»
                    span.style.cursor = 'default';
                }

                row.appendChild(span);
            });
            box.appendChild(row);
        });
        log(t('log.phase1.start'));
    });

    // 3. PF è¯†åˆ«å¨èƒ
    function identifyThreat(keyword) {
        if (myRole !== 'PF') {
            alert(t('alerts.pf_only'));
            return;
        }
        socket.emit('pf_identify_threat', {room: room, keyword: keyword});
    }

    // 4. æ˜¾ç¤º PF å†³ç­–æ¨¡æ€æ¡†
    socket.on('show_pf_decision_modal', (data) => {
        currentThreatKeyword = data.keyword;
        document.getElementById('pf-threat-keyword').innerText = data.keyword;
        document.getElementById('pf-threat-desc').innerText = translateDynamicText(data.description);

        const optionsList = document.getElementById('pf-options-list');
        optionsList.innerHTML = "";

        data.options.forEach(opt => {
            const optDiv = document.createElement('div');
            optDiv.className = 'quiz-option';
            const optionText = translateDynamicText(opt.text);
            optDiv.innerHTML = `
                <input type="radio" name="pf-option" value="${opt.id}" id="opt-${opt.id}">
                <label for="opt-${opt.id}" style="cursor: pointer; margin-left: 8px;">${optionText}</label>
            `;
            optDiv.onclick = () => {
                document.getElementById(`opt-${opt.id}`).checked = true;
                selectedOptionId = opt.id;
                // é«˜äº®é€‰ä¸­é¡¹
                document.querySelectorAll('#pf-options-list .quiz-option').forEach(el => el.classList.remove('selected'));
                optDiv.classList.add('selected');
            };
            optionsList.appendChild(optDiv);
        });

        pfDecisionModal.show();
    });

    // 5. PF æäº¤å†³ç­–
    function submitPFDecision() {
        if (!selectedOptionId) {
            alert(t('alerts.select_option'));
            return;
        }
        socket.emit('pf_submit_decision', {
            room: room,
            keyword: currentThreatKeyword,
            option_id: selectedOptionId
        });
        pfDecisionModal.hide();
        selectedOptionId = "";
    }

    // 6. PF ç­‰å¾… PM éªŒè¯
    socket.on('waiting_pm_verify', (data) => {
        log(`â³ ${translateDynamicText(data.msg)}`);
    });

    // 7. PM æ˜¾ç¤ºéªŒè¯é¢æ¿
    socket.on('show_pm_verify_panel', (data) => {
        if (myRole !== 'PM') return;

        const panel = document.getElementById('pm-verify-panel');
        document.getElementById('pm-pf-decision').innerText = translateDynamicText(data.pf_decision);
        document.getElementById('pm-sop-title').innerText = translateDynamicText(data.sop_data.title);

        const sopContent = document.getElementById('pm-sop-content');
        sopContent.innerHTML = "";
        translateDynamicArray(data.sop_data.content).forEach(line => {
            const li = document.createElement('li');
            li.innerText = line;
            sopContent.appendChild(li);
        });

        panel.style.display = 'block';
        log(t('log.pm.verify', {decision: translateDynamicText(data.pf_decision)}));
    });

    // 8. PM éªŒè¯å†³ç­–
    function pmVerify(approved) {
        socket.emit('pm_verify_decision', {room: room, approved: approved});
        document.getElementById('pm-verify-panel').style.display = 'none';
    }

    // 9. æ˜¾ç¤ºå¨èƒå†³ç­–ç»“æœ
    socket.on('threat_decision_result', (data) => {
        const localizedMsg = translateDynamicText(data.msg);
        log(`${localizedMsg} (${data.score_change >= 0 ? '+' : ''}${data.score_change})`);

        // æ ‡è®°å¨èƒå…³é”®è¯ä¸ºå·²å¤„ç†
        document.querySelectorAll('.tem-word').forEach(el => {
            if (el.innerText === data.keyword) {
                el.classList.remove('threat-keyword');
                el.classList.add('threat-processed');
                el.onclick = null;
            }
        });

        // æ·»åŠ åˆ°çŠ¶æ€åˆ—è¡¨
        const statusPanel = document.getElementById('threat-status-panel');
        const statusList = document.getElementById('threat-status-list');

        const statusItem = document.createElement('div');
        statusItem.className = `threat-status-item ${data.result}`;
        statusItem.innerHTML = `<strong>${data.keyword}:</strong> ${localizedMsg}`;
        statusList.appendChild(statusItem);

        statusPanel.style.display = 'block';

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¨èƒéƒ½å·²å¤„ç†
        const processedCount = document.querySelectorAll('.tem-word.threat-processed').length;
        if (processedCount === THREAT_KEYWORDS.length) {
            document.getElementById('btn-start-quiz').style.display = 'block';
            log(t('log.threats.complete'));
        }
    });

    // 10. å¼€å§‹æµ‹è¯•
    function startQuiz() {
        socket.emit('start_emergency_quiz', {room: room});
        document.getElementById('btn-start-quiz').style.display = 'none';
    }

    socket.on('show_emergency_quiz', (data) => {
        const container = document.getElementById('quiz-container');
        const questionsDiv = document.getElementById('quiz-questions');
        questionsDiv.innerHTML = "";

        data.questions.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'quiz-question';
            qDiv.id = `quiz-${q.id}`;
            const questionLabel = t('quiz.questionLabel', {number: idx + 1});
            const questionText = translateDynamicText(q.question);
            qDiv.innerHTML = `
                <p><strong>${questionLabel}</strong> ${questionText}</p>
                <div id="options-${q.id}"></div>
                <div id="result-${q.id}" class="mt-2" style="display:none;"></div>
            `;
            const questionLabelEl = qDiv.querySelector('p strong');
            setDynamicTranslation(questionLabelEl, 'quiz.questionLabel', {number: idx + 1});

            const optionsDiv = qDiv.querySelector(`#options-${q.id}`);
            q.options.forEach(opt => {
                const optDiv = document.createElement('div');
                optDiv.className = 'quiz-option';
                optDiv.id = `quiz-${q.id}-${opt.id}`;
                optDiv.innerHTML = `${opt.id.toUpperCase()}. ${translateDynamicText(opt.text)}`;

                if (myRole === 'PM') {
                    optDiv.onclick = () => submitQuizAnswer(q.id, opt.id);
                } else {
                    optDiv.style.cursor = 'not-allowed';
                    optDiv.style.opacity = '0.6';
                }

                optionsDiv.appendChild(optDiv);
            });

            questionsDiv.appendChild(qDiv);
        });

        container.style.display = 'block';
        log(t('log.quiz.start'));
    });

    function submitQuizAnswer(questionId, answer) {
        if (myRole !== 'PM') return;
        socket.emit('submit_quiz_answer', {room: room, question_id: questionId, answer: answer});
    }

    socket.on('quiz_answer_result', (data) => {
        const resultDiv = document.getElementById(`result-${data.question_id}`);
        const optionsDiv = document.getElementById(`options-${data.question_id}`);

        // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
        optionsDiv.querySelectorAll('.quiz-option').forEach(el => {
            el.onclick = null;
            el.style.cursor = 'default';
        });

        // æ˜¾ç¤ºç»“æœ
        resultDiv.style.display = 'block';
        resultDiv.className = data.correct ? 'alert alert-success' : 'alert alert-danger';
        resultDiv.innerHTML = '';
        const resultLabelEl = document.createElement('strong');
        setDynamicTranslation(resultLabelEl, data.correct ? 'quiz.correct' : 'quiz.incorrect');
        resultDiv.appendChild(resultLabelEl);
        const scoreSpan = document.createElement('span');
        scoreSpan.innerHTML = ` (${data.score_change >= 0 ? '+' : ''}${data.score_change})`;
        resultDiv.appendChild(scoreSpan);
        resultDiv.appendChild(document.createElement('br'));
        const explanation = document.createElement('small');
        explanation.textContent = translateDynamicText(data.explanation);
        resultDiv.appendChild(explanation);

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜éƒ½ç­”å®Œ
        const totalQuestions = document.querySelectorAll('.quiz-question').length;
        const answeredQuestions = document.querySelectorAll('[id^="result-"]').length;

        if (answeredQuestions >= totalQuestions) {
            document.getElementById('btn-next-phase').style.display = 'block';
            log(t('log.quiz.complete'));
        }
    });

    // 11. åˆ‡æ¢ Phase 2
    function reqNext() {
        socket.emit('req_phase_2', {room: room});
        const nextBtn = document.getElementById('btn-next-phase');
        setDynamicTranslation(nextBtn, 'phase1.next.waiting');
        nextBtn.disabled = true;
    }

    socket.on('start_phase_2', (data) => {
        document.getElementById('phase1-panel').style.display = 'none';
        document.getElementById('phase2-panel').style.display = 'block';
        setDynamicTranslation(document.getElementById('phase-badge'), 'phase.badge.phase2');
        document.getElementById('phase-badge').className = "badge bg-warning text-dark";
        log(t('log.phase2.start'));
    });

    // 12. é£è¡Œæ•°æ®æ›´æ–°
    socket.on('flight_update', (data) => {
        // æ›´æ–°å„ä»ªè¡¨æŒ‡é’ˆï¼ˆæ ¹æ®é‡ç¨‹æ˜ å°„åˆ° -135Â° åˆ° +135Â° æ—‹è½¬è§’åº¦ï¼‰
        // SPD: 40-200 KIAS
        document.getElementById('nd-spd').style.transform = `rotate(${(data.spd - 40) * (270 / 160) - 135}deg)`;

        // ALT: 0-10000 FT (åªæ˜¾ç¤ºåƒä½å†…çš„å˜åŒ–)
        document.getElementById('nd-alt').style.transform = `rotate(${(data.alt % 1000) * (270 / 1000) - 135}deg)`;

        // OIL P: 0-120 PSI
        document.getElementById('nd-oil').style.transform = `rotate(${(data.oil_p) * (270 / 120) - 135}deg)`;

        // RPM: 0-3000 RPM
        if (data.rpm !== undefined) {
            document.getElementById('nd-rpm').style.transform = `rotate(${(data.rpm) * (270 / 3000) - 135}deg)`;
        }

        // FUEL: 0-50 GAL (æ˜¾ç¤ºå·¦æ²¹ç®±æˆ–å¹³å‡å€¼)
        if (data.fuel_qty_left !== undefined) {
            const fuelAvg = (data.fuel_qty_left + data.fuel_qty_right) / 2;
            document.getElementById('nd-fuel').style.transform = `rotate(${fuelAvg * (270 / 50) - 135}deg)`;
        }

        // VAC: 0-7 IN HG
        if (data.vacuum !== undefined) {
            document.getElementById('nd-vacuum').style.transform = `rotate(${data.vacuum * (270 / 7) - 135}deg)`;
        }

        // AMMETER: -30 to +30 AMPS
        if (data.ammeter !== undefined) {
            document.getElementById('nd-ammeter').style.transform = `rotate(${(data.ammeter + 30) * (270 / 60) - 135}deg)`;
        }

        // æ›´æ–°è¿›åº¦
        const pos = 5 + (data.progress * 0.9);
        document.getElementById('plane-icon').style.left = `${pos}%`;
    });

    // 13. ä»ªè¡¨ç›‘æ§æ ‡è®°
    function monitorGauge(gaugeId) {
        socket.emit('monitor_gauge', {room: room, gauge_id: gaugeId});
    }

    // 14. æ¥æ”¶ä»ªè¡¨ç›‘æ§ç¡®è®¤
    socket.on('gauge_monitored', (data) => {
        const gaugeEl = document.querySelector(`[data-gauge-id="${data.gauge_id}"]`);
        if (gaugeEl) {
            gaugeEl.classList.add('monitored');
        }
        log(`ğŸ‘ï¸ ${translateDynamicText(data.msg)}`);
    });

    // 15. æ¥æ”¶å¾å…†æ£€æµ‹æˆåŠŸ
    socket.on('precursor_detected', (data) => {
        const alertBox = document.getElementById('alert-box');
        alertBox.className = 'alert alert-success fw-bold';
        clearElementTranslation(alertBox);
        const localizedMsg = translateDynamicText(data.msg);
        alertBox.innerText = localizedMsg;

        log(`${localizedMsg} (+${data.score})`);

        // 3ç§’åæ¢å¤æ­£å¸¸
        setTimeout(() => {
            alertBox.className = 'alert alert-dark text-center';
            setDynamicTranslation(alertBox, 'alerts.monitoring');
        }, 3000);
    });

    socket.on('event_trigger', (data) => {
        const alertBox = document.getElementById('alert-box');
        alertBox.className = `alert alert-danger fw-bold blink`;
        clearElementTranslation(alertBox);
        const localizedMsg = translateDynamicText(data.msg);
        alertBox.innerText = `âš ï¸ ${localizedMsg}`;

        const track = document.getElementById('route-track');
        const dot = document.createElement('div');
        dot.className = `event-dot dot-${data.type}`;
        dot.style.left = `${5 + (data.progress * 0.9)}%`;
        track.appendChild(dot);
        log(`EVENT: ${localizedMsg}`);
    });

    // 13. æ£€æŸ¥å•ä¸ç»“ç®— (Phase 3)
    function selQRH(key) { socket.emit('select_checklist', {room: room, key: key}); }

    socket.on('show_checklist', (data) => {
        document.getElementById('chk-panel').style.display = 'block';
        document.getElementById('chk-title').innerText = translateDynamicText(data.title);
        document.getElementById('chk-msg').innerText = translateDynamicText(data.msg);
        const list = document.getElementById('chk-list');
        list.innerHTML = "";
        translateDynamicArray(data.items).forEach((txt, i) => {
            list.innerHTML += `<div id="item-${i}" class="checklist-item" onclick="checkItem(${i})">â¬œ ${txt}</div>`;
        });
    });

    function checkItem(i) { socket.emit('check_item', {room: room, index: i}); }

    socket.on('item_checked', (data) => {
        const el = document.getElementById(`item-${data.index}`);
        el.className = "checklist-item done";
        el.innerText = el.innerText.replace("â¬œ", "âœ…");
        log(t('log.check_item', {role: data.role, index: data.index + 1}));
    });

    socket.on('mission_complete', (data) => {
        const modal = new bootstrap.Modal(document.getElementById('endModal'));
        document.getElementById('end-score').innerText = data.score;
        document.getElementById('end-res').innerText = data.result;
        document.getElementById('end-sum').innerText = data.summary;
        modal.show();
    });

    // æ£€æŸ¥å•å®Œæˆï¼ˆä¸æ˜¯ä»»åŠ¡å®Œæˆï¼‰
    socket.on('checklist_complete', (data) => {
        log(translateDynamicText(data.msg));
        // éšè—æ£€æŸ¥å•é¢æ¿ï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­é€‰æ‹©å…¶ä»– QRH
        document.getElementById('chk-panel').style.display = 'none';

        // æ¸…é™¤å³ä¸Šè§’çš„å‘Šè­¦æ˜¾ç¤º
        const alertBox = document.getElementById('alert-box');
        alertBox.className = 'alert alert-dark text-center';
        setDynamicTranslation(alertBox, 'alerts.normal');
    });

    socket.on('update_score', (data) => {
        document.getElementById('score').innerText = data.score;
    });

    socket.on('sys_msg', (d) => log(translateDynamicText(d.msg)));

    socket.on('error_msg', (data) => {
        alert(translateDynamicText(data.msg));
    });

    // æˆ¿é—´å·²æ»¡å¤„ç†
    socket.on('room_full', (data) => {
        alert(`âŒ ${translateDynamicText(data.msg)}`);
        location.reload();
    });

    // ç”¨æˆ·äººæ•°æ›´æ–°
    socket.on('user_count_update', (data) => {
        log(t('log.user_count', {count: data.count, users: data.usernames.join(', ')}));
    });

    // ç”¨æˆ·ç¦»å¼€å¤„ç†
    socket.on('user_left', (data) => {
        log(t('log.user_left', {username: data.username, role: data.role, remaining: data.remaining_count}));
        if (data.remaining_count < 2) {
            alert(t('alerts.partner_left', {username: data.username}));
        }
    });

    function log(msg) {
        addSystemMessage(msg);
    }

    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    function addSystemMessage(msg) {
        const chatBox = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message msg-system';
        msgDiv.innerHTML = `<span>ğŸ”” ${msg}</span>`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // æ·»åŠ èŠå¤©æ¶ˆæ¯
    function addChatMessage(sender, role, message, timestamp, enableTTS = false) {
        const chatBox = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');

        // ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
        const messageId = `msg_${messageCounter++}`;

        // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
        const isMyMessage = role === myRole;
        const messageClass = isMyMessage ? `msg-${role.toLowerCase()}` : `msg-${role.toLowerCase()}`;

        msgDiv.className = `chat-message ${messageClass}`;
        msgDiv.id = messageId;

        const locale = currentLang === 'zh' ? 'zh-CN' : 'en-US';
        const time = new Date(timestamp).toLocaleTimeString(locale, {
            hour: '2-digit',
            minute: '2-digit'
        });

        msgDiv.innerHTML = `
            <span class="msg-sender">${sender} (${role})</span>
            <div>${message}</div>
            <span class="msg-timestamp">${time}</span>
        `;

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”å¯ç”¨äº†TTSï¼Œè¯·æ±‚è¯­éŸ³
        if (enableTTS) {
            requestTTS(message, messageId);
        }
    }

    // å‘é€èŠå¤©æ¶ˆæ¯
    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();

        if (!message) return;

        // å‘é€åˆ°æœåŠ¡å™¨
        socket.emit('send_chat_message', {
            room: room,
            message: message
        });

        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
    }

    // ç›‘å¬èŠå¤©æ¶ˆæ¯
    socket.on('chat_message', (data) => {
        // æ£€æŸ¥æ˜¯å¦åº”è¯¥å¯ç”¨TTSï¼ˆAIæ¶ˆæ¯ä¸”æœ‰enable_ttsæ ‡å¿—ï¼‰
        const enableTTS = data.enable_tts === true;
        addChatMessage(data.username, data.role, data.message, data.timestamp, enableTTS);
    });

    // æ”¯æŒå›è½¦å‘é€
    document.addEventListener('DOMContentLoaded', () => {
        applyLanguage(currentLang);
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        }
    });

    // QRHåº“æŠ˜å /å±•å¼€æ§åˆ¶
    function toggleQRHPanel() {
        const content = document.getElementById('qrh-content');
        const icon = document.getElementById('qrh-icon');

        if (content.classList.contains('expanded')) {
            // æ”¶èµ·
            content.classList.remove('expanded');
            icon.classList.remove('expanded');
        } else {
            // å±•å¼€
            content.classList.add('expanded');
            icon.classList.add('expanded');
        }
    }

</script>
</body>
</html>
